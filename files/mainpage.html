<html>

<head>
    <title>Girland control</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class='main'>
        <h3>Garland Control</h3>
        <p>Free heap: <span id='heap'></span></p>
        <div id='controls'>
        </div>
    </div>
</body>

<script>
    const formStructure = [
        {
            a: ['all'],
            n: 'Mode set',
            p: '/mode',
            c: [
                {
                    n: 'RAINBOW',
                    t: 'button',
                },
                {
                    n: 'WAVE',
                    t: 'button',
                },
                {
                    n: 'TAPES',
                    t: 'button',
                },
                {
                    n: 'SNOW',
                    t: 'button',
                },
                {
                    n: 'TORNADO',
                    t: 'button',
                },
                {
                    n: 'MATRIX',
                    t: 'button',
                },
                {
                    n: 'DISABLE',
                    t: 'button',
                }
            ]
        },
        {
            a: [0, 1],
            n: 'Direction set',
            p: '/dir',
            c: [
                {
                    n: 'FORWARD',
                    t: 'button',
                },
                {
                    n: 'BACKWARD',
                    t: 'button',
                },
            ]
        },
        {
            a: [0, 1, 2],
            n: 'Speed set',
            p: '/speed',
            c: [
                {
                    n: 'FAST',
                    t: 'button',
                },
                {
                    n: 'MIDDLE',
                    t: 'button',
                },
                {
                    n: 'SLOW',
                    t: 'button',
                },
            ]
        },
        {
            a: [0],
            n: 'Align set',
            p: '/align',
            c: [
                {
                    n: 'VERTICAL',
                    t: 'button',
                },
                {
                    n: 'HORISONTAL',
                    t: 'button',
                }
            ]
        }, {
            a: [1],
            n: 'Mirror set',
            p: '/mirror',
            c: [
                {
                    n: 'MIRROR',
                    t: 'button',
                },
                {
                    n: 'NOT_MIRROR',
                    t: 'button',
                }
            ]
        }, {
            a: [1,2,3,4,5],
            n: 'Main color set',
            p: '/maincolor',
            c: [
                {
                    n: 'MAIN_COLOR',
                    t: 'range',
                    f: 'ch',
                    min: 0,
                    max: 360,
                },
            ]
        }, {
            a: [4,5],
            n: 'Tail set',
            p: '/tail',
            c: [
                {
                    n: 'COLOR',
                    t: 'range',
                    f: 'th',
                    min: 0,
                    max:360,
                },
                {
                    n: 'LENGTH',
                    t: 'range',
                    f: 'tl',
                    min: 0,
                    max: 100,

                },
                
            ]
        },
        {
            a: ['all'],
            n: 'Settings',
            c: [{ n: 'SETTINGS', t: 'link', u: 'settings' }]
        }
    ];

    function s(p) {
        fetch(p).then(r => r.json().then(render));
    };
    function render(state) {
        console.log(state);
        document.getElementById('heap').innerText=state.fh;
        const root = document.getElementById('controls');
        root.innerHTML = '';
        formStructure.forEach((cg => {
            if (cg.a.includes(state.m) || cg.a.includes('all')) {
                const container = document.createElement('div');
                container.innerHTML = `<span>${cg.n}: </span><br/>`;
                cg.c.forEach(c=>{
                    const e = document.createElement('input');
                    e.setAttribute('type', c.t);
                    if(c.t==='button') {
                        e.addEventListener('click', ()=>s(`${cg.p}/${c.n}`));
                        container.appendChild(e);
                        e.setAttribute('value', c.n);
                    } else if(c.t==='range') {
                        const cr = document.createElement('div');
                        cr.appendChild(e);
                        cr.innerText=c.n;
                        container.appendChild(cr);
                        e.setAttribute('min', c.min);
                        e.setAttribute('max', c.max);
                        e.value = state[c.f];
                        e.addEventListener('input', (e)=>s(`${cg.p}/${c.n}/${String(e.target.value).padStart(3,0)}`));
                    } else if(c.t==='link') {
                        e.addEventListener('click', () => window.location=`${window.location.href}${c.u}`);
                        container.appendChild(e);
                        e.setAttribute('type', 'button');
                        e.setAttribute('value', c.n);
                    }
                    container.appendChild(e);
                });
                root.appendChild(container);
            }
        }));
    };
    s('/status');
</script>

</html>